{% set currentView = fsc.getCurrentView() %}
{% set firstView = fsc.views | first %}

{% include 'Macro/Toasts.html.twig' %}

<script>
    let wooCategories = [];

    function createNewProduct(action) {
        animateSpinner('add');

        const fsProductId = "{{ fsc.model.idproducto }}";
        if (!fsProductId) {
            alert('Primero guarda el producto en FacturaScripts');
            animateSpinner('remove');
            return false;
        }

        const data = new FormData();
        data.append('action', action);
        data.append('fs_id', fsProductId);

        fetch('{{ fsc.url() }}', {
            method: 'POST',
            body: data
        }).then(function (response) {
            animateSpinner('remove', true);
            return response.json().then(data => ({
                status: response.status,
                ok: response.ok,
                data: data
            }));
        }).then(function (result) {
            if (result.ok && result.data.success) {
                alert('Producto sincronizado exitosamente con WooCommerce!');
                location.reload(); // Reload to show the edit form
            } else {
                if (result.data.messages && Array.isArray(result.data.messages)) {
                    const errorMessages = result.data.messages.map(msg => msg.message).join('\n');
                    alert('Error: ' + errorMessages);
                } else {
                    alert('Error al sincronizar el producto');
                }
            }
        }).catch(function (error) {
            alert('Error de conexi√≥n al sincronizar producto');
            console.error('Sync error:', error);
            animateSpinner('remove', false);
        });
        return false;
    }

    function updateWooCommerceProduct() {
        animateSpinner('add');

        const fsProductId = "{{ fsc.model.idproducto }}";
        const form = document.getElementById('wooCommerceForm');
        const formData = new FormData(form);
        formData.append('action', 'update-wc-product');
        formData.append('fs_id', fsProductId);

        fetch('{{ fsc.url() }}', {
            method: 'POST',
            body: formData
        }).then(function (response) {
            animateSpinner('remove', true);
            return response.json().then(data => ({
                status: response.status,
                ok: response.ok,
                data: data
            }));
        }).then(function (result) {
            if (result.ok && result.data.success) {
                showSuccessMessage('Producto actualizado exitosamente en WooCommerce');
            } else {
                if (result.data.messages && Array.isArray(result.data.messages)) {
                    const errorMessages = result.data.messages.map(msg => msg.message).join('\n');
                    alert('Error: ' + errorMessages);
                } else {
                    alert('Error al actualizar el producto');
                }
            }
        }).catch(function (error) {
            alert('Error de conexi√≥n al actualizar producto');
            console.error('Update error:', error);
            animateSpinner('remove', false);
        });
        return false;
    }

    function syncFromWooCommerce() {
        animateSpinner('add');

        const fsProductId = "{{ fsc.model.idproducto }}";
        const data = new FormData();
        data.append('action', 'sync-from-wc');
        data.append('fs_id', fsProductId);

        fetch('{{ fsc.url() }}', {
            method: 'POST',
            body: data
        }).then(function (response) {
            animateSpinner('remove', true);
            return response.json().then(data => ({
                status: response.status,
                ok: response.ok,
                data: data
            }));
        }).then(function (result) {
            if (result.ok && result.data.success) {
                showSuccessMessage('Datos sincronizados desde WooCommerce');
                setTimeout(() => location.reload(), 1500);
            } else {
                if (result.data.messages && Array.isArray(result.data.messages)) {
                    const errorMessages = result.data.messages.map(msg => msg.message).join('\n');
                    alert('Error: ' + errorMessages);
                } else {
                    alert('Error al sincronizar datos');
                }
            }
        }).catch(function (error) {
            alert('Error de conexi√≥n');
            console.error('Sync error:', error);
            animateSpinner('remove', false);
        });
    }

    function loadWooCommerceCategories() {
        const data = new FormData();
        data.append('action', 'get-wc-categories');

        fetch('{{ fsc.url() }}', {
            method: 'POST',
            body: data
        }).then(function (response) {
            return response.json();
        }).then(function (result) {
            if (result.success && result.categories) {
                wooCategories = result.categories;
                populateCategorySelect();
            }
        }).catch(function (error) {
            console.error('Categories load error:', error);
        });
    }

    function populateCategorySelect() {
        const select = document.getElementById('woo_categories');
        if (!select) return;

        // Clear existing options except "Select categories"
        select.innerHTML = '<option value="">Seleccionar categor√≠as...</option>';

        wooCategories.forEach(function (category) {
            const option = document.createElement('option');
            option.value = category.id;
            option.textContent = category.name + ' (' + (category.count || 0) + ')';

            // Pre-select if this category is already assigned
            const currentCategories = getSelectedCategoryIds();
            if (currentCategories.includes(category.id)) {
                option.selected = true;
            }

            select.appendChild(option);
        });
    }

    function getSelectedCategoryIds() {
        const categoriesData = '{{ fsc.model.woo_categories ?? "" }}';
        if (!categoriesData) return [];

        try {
            const categories = JSON.parse(categoriesData);
            return categories.map(cat => cat.id);
        } catch (e) {
            return [];
        }
    }

    function showCreateCategoryModal() {
        const modal = document.getElementById('createCategoryModal');
        if (modal) {
            modal.style.display = 'block';
        }
    }

    function hideCreateCategoryModal() {
        const modal = document.getElementById('createCategoryModal');
        if (modal) {
            modal.style.display = 'none';
        }
        document.getElementById('newCategoryName').value = '';
    }

    function createNewCategory() {
        const categoryName = document.getElementById('newCategoryName').value.trim();
        if (!categoryName) {
            alert('Ingresa un nombre para la categor√≠a');
            return;
        }

        const data = new FormData();
        data.append('action', 'create-wc-category');
        data.append('category_name', categoryName);

        fetch('{{ fsc.url() }}', {
            method: 'POST',
            body: data
        }).then(function (response) {
            return response.json();
        }).then(function (result) {
            if (result.success && result.category) {
                wooCategories.push({
                    id: result.category.id,
                    name: result.category.name,
                    count: 0
                });
                populateCategorySelect();

                // Select the newly created category
                const select = document.getElementById('woo_categories');
                const newOption = Array.from(select.options).find(option => option.value == result.category.id);
                if (newOption) {
                    newOption.selected = true;
                }

                hideCreateCategoryModal();
                showSuccessMessage('Categor√≠a creada exitosamente');
            } else {
                const errorMessages = result.messages ? result.messages.map(msg => msg.message).join('\n') : 'Error desconocido';
                alert('Error al crear la categor√≠a: ' + errorMessages);
            }
        }).catch(function (error) {
            alert('Error de conexi√≥n al crear categor√≠a');
            console.error('Create category error:', error);
        });
    }

    function showSuccessMessage(message) {
        const alertContainer = document.getElementById('successAlert');
        if (alertContainer) {
            alertContainer.innerHTML = `
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="fas fa-check-circle"></i> ${message}
                    <button type="button" class="close" data-dismiss="alert">
                        <span>&times;</span>
                    </button>
                </div>
            `;
            setTimeout(function () {
                const alert = alertContainer.querySelector('.alert');
                if (alert) {
                    alert.remove();
                }
            }, 5000);
        }
    }

    function toggleStockManagement() {
        const manageStockCheckbox = document.getElementById('woo_manage_stock');
        const stockQuantityInput = document.getElementById('woo_stock_quantity');

        if (manageStockCheckbox && stockQuantityInput) {
            stockQuantityInput.disabled = !manageStockCheckbox.checked;
        }
    }

    // Load categories when the form is displayed
    document.addEventListener('DOMContentLoaded', function () {
        if (document.getElementById('wooCommerceForm')) {
            loadWooCommerceCategories();
            toggleStockManagement();

            // Add event listener for stock management toggle
            const manageStockCheckbox = document.getElementById('woo_manage_stock');
            if (manageStockCheckbox) {
                manageStockCheckbox.addEventListener('change', toggleStockManagement);
            }
        }
    });
</script>

<style>
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        border-radius: 5px;
        width: 400px;
        max-width: 90%;
    }

    .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
    }

    .status-published {
        background-color: #28a745;
    }

    .status-draft {
        background-color: #ffc107;
    }

    .status-private {
        background-color: #dc3545;
    }

    .woo-form-section {
        border: 1px solid #e3e6f0;
        border-radius: 5px;
        padding: 1rem;
        margin-bottom: 1rem;
        background-color: #f8f9fc;
    }

    .woo-form-section h6 {
        color: #5a5c69;
        border-bottom: 1px solid #e3e6f0;
        padding-bottom: 0.5rem;
        margin-bottom: 1rem;
    }

    .field-help {
        font-size: 0.875rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }
</style>

{% block body %}
    <div class="container-fluid">
        <div class="row">
            <div class="col">

                <div id="successAlert"></div>

                {% if fsc.model.woo_id %}
                    {# WooCommerce Edit Form #}
                    <div class="card shadow mb-4">
                        <div class="card-header py-3 d-flex justify-content-between align-items-center">
                            <h5 class="m-0 font-weight-bold text-primary">
                                <i class="fas fa-edit"></i> Editar Producto WooCommerce
                            </h5>
                            <div class="d-flex align-items-center">
                                <span class="status-indicator status-{{ fsc.model.woo_status ?? 'draft' }}"></span>
                                <span class="text-muted small mr-3">
                                    Estado: {{ (fsc.model.woo_status ?? 'Draft')|title }}
                                    {% if fsc.model.woo_status == 'publish' %}
                                        <i class="fas fa-eye text-success ml-1" title="Visible en tienda"></i>
                                    {% else %}
                                        <i class="fas fa-eye-slash text-warning ml-1" title="No visible en tienda"></i>
                                    {% endif %}
                                </span>
                                <button type="button" class="btn btn-sm btn-outline-info"
                                        onclick="syncFromWooCommerce()" title="Sincronizar datos desde WooCommerce">
                                    <i class="fas fa-sync-alt"></i> Sync
                                </button>
                            </div>
                        </div>
                        <div class="card-body">

                            {# WooCommerce Info #}
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <strong>WooCommerce ID:</strong> {{ fsc.model.woo_id }}
                                </div>
                                <div class="col-md-3">
                                    <strong>FS Referencia:</strong> {{ fsc.model.referencia }}
                                </div>
                                <div class="col-md-3">
                                    <strong>Stock FS:</strong> {{ fsc.model.stockfis ?? 0 }}
                                </div>
                                <div class="col-md-3">
                                    {% if fsc.model.woo_permalink %}
                                        <a href="{{ fsc.model.woo_permalink }}" target="_blank"
                                           class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-external-link-alt"></i> Ver en tienda
                                        </a>
                                    {% endif %}
                                </div>
                            </div>

                            <hr>

                            {# Edit Form #}
                            <form id="wooCommerceForm" onsubmit="updateWooCommerceProduct(); return false;">

                                {# Basic Info Section #}
                                <div class="woo-form-section">
                                    <h6><i class="fas fa-info-circle"></i> Informaci√≥n B√°sica</h6>

                                    <div class="row">
                                        <div class="col-md-8">
                                            <div class="form-group">
                                                <label for="woo_product_name">
                                                    <strong>Nombre del Producto</strong>
                                                </label>
                                                <input type="text" class="form-control" id="woo_product_name"
                                                       name="woo_product_name"
                                                       value="{{ fsc.model.woo_product_name ?? fsc.model.descripcion }}"
                                                       required>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label for="woo_status">
                                                    <strong>Estado</strong>
                                                    <i class="fas fa-info-circle text-muted"
                                                       title="Publish = Visible en tienda, Draft = Oculto"></i>
                                                </label>
                                                <select class="form-control" id="woo_status" name="woo_status">
                                                    <option value="publish" {{ fsc.model.woo_status == 'publish' ? 'selected' : '' }}>
                                                        üü¢ Publicado (Visible)
                                                    </option>
                                                    <option value="draft" {{ fsc.model.woo_status == 'draft' or not fsc.model.woo_status ? 'selected' : '' }}>
                                                        üü° Borrador (Oculto)
                                                    </option>
                                                    <option value="private" {{ fsc.model.woo_status == 'private' ? 'selected' : '' }}>
                                                        üî¥ Privado
                                                    </option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="woo_short_description">Descripci√≥n Corta</label>
                                                <textarea class="form-control" id="woo_short_description"
                                                          name="woo_short_description"
                                                          rows="3">{{ fsc.model.woo_short_description ?? fsc.model.descripcion }}</textarea>
                                                <div class="field-help">Descripci√≥n breve que aparece en listados de
                                                    productos
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="woo_description">Descripci√≥n Larga</label>
                                                <textarea class="form-control" id="woo_description"
                                                          name="woo_description"
                                                          rows="3">{{ fsc.model.woo_description ?? fsc.model.observaciones }}</textarea>
                                                <div class="field-help">Descripci√≥n completa que aparece en la p√°gina
                                                    del producto
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {# Pricing Section #}
                                <div class="woo-form-section">
                                    <h6><i class="fas fa-euro-sign"></i> Precios y Configuraci√≥n</h6>

                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label for="woo_sku">SKU</label>
                                                <input type="text" class="form-control" id="woo_sku" name="woo_sku"
                                                       value="{{ fsc.model.woo_sku ?? fsc.model.referencia }}">
                                                <div class="field-help">C√≥digo √∫nico del producto</div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label for="woo_price">Precio Regular (‚Ç¨)</label>
                                                <input type="number" step="0.01" class="form-control" id="woo_price"
                                                       name="woo_price"
                                                       value="{{ fsc.model.woo_price ?? fsc.model.precio }}">
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label for="woo_sale_price">Precio Oferta (‚Ç¨)</label>
                                                <input type="number" step="0.01" class="form-control"
                                                       id="woo_sale_price" name="woo_sale_price"
                                                       value="{{ fsc.model.woo_sale_price ?? '' }}"
                                                       placeholder="Opcional">
                                                <div class="field-help">Precio con descuento (opcional)</div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label for="woo_tax_status">Estado de Impuestos</label>
                                                <select class="form-control" id="woo_tax_status" name="woo_tax_status">
                                                    <option value="taxable" {{ fsc.model.woo_tax_status == 'taxable' or not fsc.model.woo_tax_status ? 'selected' : '' }}>
                                                        Gravable
                                                    </option>
                                                    <option value="shipping" {{ fsc.model.woo_tax_status == 'shipping' ? 'selected' : '' }}>
                                                        Solo Env√≠o
                                                    </option>
                                                    <option value="none" {{ fsc.model.woo_tax_status == 'none' ? 'selected' : '' }}>
                                                        Sin Impuestos
                                                    </option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label for="woo_catalog_visibility">Visibilidad en Cat√°logo</label>
                                                <select class="form-control" id="woo_catalog_visibility"
                                                        name="woo_catalog_visibility">
                                                    <option value="visible" {{ fsc.model.woo_catalog_visibility == 'visible' or not fsc.model.woo_catalog_visibility ? 'selected' : '' }}>
                                                        Cat√°logo y B√∫squeda
                                                    </option>
                                                    <option value="catalog" {{ fsc.model.woo_catalog_visibility == 'catalog' ? 'selected' : '' }}>
                                                        Solo Cat√°logo
                                                    </option>
                                                    <option value="search" {{ fsc.model.woo_catalog_visibility == 'search' ? 'selected' : '' }}>
                                                        Solo B√∫squeda
                                                    </option>
                                                    <option value="hidden" {{ fsc.model.woo_catalog_visibility == 'hidden' ? 'selected' : '' }}>
                                                        Oculto
                                                    </option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-8">
                                            <div class="form-group">
                                                <label>Caracter√≠sticas del Producto</label>

                                                <div class="form-check-inline">
                                                    <input type="checkbox" class="form-check-input" id="woo_featured"
                                                           name="woo_featured"
                                                           value="yes" {{ fsc.model.woo_featured ? 'checked' : '' }}>
                                                    <label class="form-check-label mr-3"
                                                           for="woo_featured">Destacado</label>
                                                </div>

                                                <div class="form-check-inline">
                                                    <input type="checkbox" class="form-check-input" id="woo_virtual"
                                                           name="woo_virtual"
                                                           value="yes" {{ fsc.model.woo_virtual ? 'checked' : '' }}>
                                                    <label class="form-check-label mr-3"
                                                           for="woo_virtual">Virtual</label>
                                                </div>

                                                <div class="form-check-inline">
                                                    <input type="checkbox" class="form-check-input"
                                                           id="woo_downloadable" name="woo_downloadable"
                                                           value="yes" {{ fsc.model.woo_downloadable ? 'checked' : '' }}>
                                                    <label class="form-check-label mr-3" for="woo_downloadable">Descargable</label>
                                                </div>

                                                <div class="form-check-inline">
                                                    <input type="checkbox" class="form-check-input"
                                                           id="woo_reviews_allowed" name="woo_reviews_allowed"
                                                           value="yes" {{ fsc.model.woo_reviews_allowed ? 'checked' : '' }}>
                                                    <label class="form-check-label" for="woo_reviews_allowed">Permitir
                                                        Rese√±as</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {# Inventory Section #}
                                <div class="woo-form-section">
                                    <h6><i class="fas fa-boxes"></i> Inventario</h6>

                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <div class="form-check">
                                                    <input type="checkbox" class="form-check-input"
                                                           id="woo_manage_stock" name="woo_manage_stock"
                                                           value="yes" {{ fsc.model.woo_manage_stock ? 'checked' : '' }}>
                                                    <label class="form-check-label" for="woo_manage_stock">
                                                        <strong>Gestionar Stock</strong>
                                                    </label>
                                                </div>
                                                <div class="field-help">Activa el control de inventario para este
                                                    producto
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label for="woo_stock_quantity">Cantidad en Stock</label>
                                                <input type="number" class="form-control" id="woo_stock_quantity"
                                                       name="woo_stock_quantity"
                                                       value="{{ fsc.model.woo_stock_quantity ?? fsc.model.stockfis ?? 0 }}">
                                                <div class="field-help">FS: {{ fsc.model.stockfis ?? 0 }}</div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label for="woo_weight">Peso (kg)</label>
                                                <input type="number" step="0.001" class="form-control" id="woo_weight"
                                                       name="woo_weight"
                                                       value="{{ fsc.model.woo_weight ?? '' }}" placeholder="0.000">
                                                <div class="field-help">Peso para c√°lculo de env√≠o</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {# Shipping Section #}
                                <div class="woo-form-section">
                                    <h6><i class="fas fa-shipping-fast"></i> Dimensiones</h6>

                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label for="woo_length">Largo (cm)</label>
                                                <input type="number" step="0.1" class="form-control" id="woo_length"
                                                       name="woo_length"
                                                       value="{{ fsc.model.woo_length ?? '' }}" placeholder="0.0">
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label for="woo_width">Ancho (cm)</label>
                                                <input type="number" step="0.1" class="form-control" id="woo_width"
                                                       name="woo_width"
                                                       value="{{ fsc.model.woo_width ?? '' }}" placeholder="0.0">
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label for="woo_height">Alto (cm)</label>
                                                <input type="number" step="0.1" class="form-control" id="woo_height"
                                                       name="woo_height"
                                                       value="{{ fsc.model.woo_height ?? '' }}" placeholder="0.0">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="field-help">Dimensiones para c√°lculo de costos de env√≠o</div>
                                </div>

                                {# Categories Section #}
                                <div class="woo-form-section">
                                    <h6><i class="fas fa-tags"></i> Categor√≠as</h6>

                                    <div class="row">
                                        <div class="col-md-8">
                                            <div class="form-group">
                                                <label for="woo_categories">Categor√≠as del Producto</label>
                                                <select class="form-control" id="woo_categories" name="woo_categories[]"
                                                        multiple size="5">
                                                    <option value="">Cargando categor√≠as...</option>
                                                </select>
                                                <div class="field-help">Mant√©n Ctrl presionado para seleccionar
                                                    m√∫ltiples categor√≠as
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label>&nbsp;</label>
                                                <div>
                                                    <button type="button" class="btn btn-outline-secondary btn-block"
                                                            onclick="showCreateCategoryModal()">
                                                        <i class="fas fa-plus"></i> Nueva Categor√≠a
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {# Save Button #}
                                <div class="row mt-4">
                                    <div class="col text-center">
                                        <button type="submit" class="btn btn-lg btn-success btn-spin-action">
                                            <i class="fas fa-save fa-fw"></i>
                                            <span class="d-none d-sm-inline-block">Actualizar Producto WooCommerce</span>
                                        </button>
                                    </div>
                                </div>

                            </form>
                        </div>
                    </div>

                    {# Sync Info Card #}
                    <div class="card shadow mb-4">
                        <div class="card-body">
                            <h6 class="text-muted"><i class="fas fa-info-circle"></i> Informaci√≥n de Sincronizaci√≥n</h6>
                            <div class="row small text-muted">
                                <div class="col-md-3">
                                    <strong>Creado:</strong><br>
                                    {{ fsc.model.woo_creation_date ?? 'N/A' }}<br>
                                    <small>por: {{ fsc.model.woo_nick ?? 'N/A' }}</small>
                                </div>
                                <div class="col-md-3">
                                    <strong>√öltima actualizaci√≥n:</strong><br>
                                    {{ fsc.model.woo_last_update ?? 'N/A' }}<br>
                                    <small>por: {{ fsc.model.woo_last_nick ?? 'N/A' }}</small>
                                </div>
                                <div class="col-md-4">
                                    <strong>URL WooCommerce:</strong><br>
                                    {% if fsc.model.woo_permalink %}
                                        <a href="{{ fsc.model.woo_permalink }}" target="_blank" class="text-primary">
                                            {{ fsc.model.woo_permalink|length > 50 ? fsc.model.woo_permalink|slice(0, 50) ~ '...' : fsc.model.woo_permalink }}
                                        </a>
                                    {% else %}
                                        <span class="text-muted">No disponible</span>
                                    {% endif %}
                                </div>
                                <div class="col-md-2">
                                    <strong>Datos WooCommerce:</strong><br>
                                    {% if fsc.model.woo_categories %}
                                        {% set categories = json_decode(fsc.model.woo_categories) %}
                                        <small>{{ categories|length }} categor√≠as</small><br>
                                    {% endif %}
                                    {% if fsc.model.woo_images %}
                                        {% set images = json_decode(fsc.model.woo_images) %}
                                        <small>{{ images|length }} im√°genes</small><br>
                                    {% endif %}
                                    {% if fsc.model.woo_dimensions %}
                                        <small>Con dimensiones</small><br>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                {% else %}
                    {# Initial Sync Card #}
                    <div class="card shadow mb-4">
                        <div class="card-header py-3">
                            <h5 class="m-0 font-weight-bold text-primary">
                                <i class="fas fa-cube"></i> Sincronizaci√≥n WooCommerce
                            </h5>
                        </div>
                        <div class="card-body">

                            {# Product Info #}
                            {% if fsc.model.idproducto %}
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <strong>Referencia:</strong> {{ fsc.model.referencia ?? 'Sin referencia' }}
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Descripci√≥n:</strong> {{ fsc.model.descripcion ?? 'Sin descripci√≥n' }}
                                    </div>
                                </div>

                                <div class="row mb-4">
                                    <div class="col-md-3">
                                        <strong>Precio:</strong> {{ fsc.model.precio ?? '0' }} ‚Ç¨
                                    </div>
                                    <div class="col-md-3">
                                        <strong>Stock:</strong> {{ fsc.model.stockfis ?? '0' }}
                                    </div>
                                    <div class="col-md-3">
                                        <span class="badge badge-secondary">No sincronizado</span>
                                    </div>
                                    <div class="col-md-3">
                                        {% if fsc.model.observaciones %}
                                            <strong>Observaciones:</strong><br>
                                            <small class="text-muted">{{ fsc.model.observaciones|length > 50 ? fsc.model.observaciones|slice(0, 50) ~ '...' : fsc.model.observaciones }}</small>
                                        {% endif %}
                                    </div>
                                </div>

                                {# Validation Check #}
                                <div class="alert alert-info">
                                    <h6><i class="fas fa-check-circle"></i> Verificaci√≥n de Datos</h6>
                                    <div class="row">
                                        <div class="col-md-4">
                                            {% if fsc.model.descripcion %}
                                                <i class="fas fa-check text-success"></i> Descripci√≥n: OK
                                            {% else %}
                                                <i class="fas fa-times text-danger"></i> <span class="text-danger">Descripci√≥n requerida</span>
                                            {% endif %}
                                        </div>
                                        <div class="col-md-4">
                                            {% if fsc.model.referencia %}
                                                <i class="fas fa-check text-success"></i> Referencia: OK
                                            {% else %}
                                                <i class="fas fa-times text-danger"></i> <span class="text-danger">Referencia requerida</span>
                                            {% endif %}
                                        </div>
                                        {#                                        <div class="col-md-4"> #}
                                        {#                                            {% if fsc.model.precio and fsc.model.precio >= 0 %} #}
                                        {#                                                <i class="fas fa-check text-success"></i> Precio: OK #}
                                        {#                                            {% else %} #}
                                        {#                                                <i class="fas fa-times text-danger"></i> <span class="text-danger">Precio v√°lido requerido</span> #}
                                        {#                                            {% endif %} #}
                                        {#                                        </div> #}
                                    </div>
                                </div>
                            {% endif %}

                            {# Sync Actions #}
                            <div class="text-center">
                                {% if fsc.model.idproducto %}
                                    {% set canSync = fsc.model.descripcion and fsc.model.referencia and fsc.model.precio is defined and fsc.model.precio >= 0 %}

                                    {% if canSync %}
                                        <p class="mb-4 text-success">
                                            <i class="fas fa-check-circle"></i>
                                            El producto est√° listo para sincronizar con WooCommerce
                                        </p>

                                        <button type="button"
                                                class="btn btn-lg btn-primary btn-spin-action btn-sync-woo"
                                                onclick="return createNewProduct('create-wc-product')">
                                            <i class="fas fa-sync fa-fw"></i>
                                            <span class="d-none d-sm-inline-block">Sincronizar con WooCommerce</span>
                                        </button>
                                    {% else %}
                                        <p class="mb-4 text-warning">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            Completa los datos requeridos antes de sincronizar
                                        </p>

                                        <button type="button" class="btn btn-lg btn-warning" disabled>
                                            <i class="fas fa-exclamation-triangle fa-fw"></i>
                                            <span class="d-none d-sm-inline-block">Datos incompletos</span>
                                        </button>
                                    {% endif %}

                                {% else %}
                                    <div class="alert alert-warning">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        Primero debes guardar el producto en FacturaScripts
                                    </div>

                                    <button type="button" class="btn btn-lg btn-secondary" disabled>
                                        <i class="fas fa-save fa-fw"></i>
                                        <span class="d-none d-sm-inline-block">Primero guarda el producto</span>
                                    </button>
                                {% endif %}

                                <div class="mt-3 text-muted small">
                                    <i class="fas fa-info-circle"></i>
                                    La sincronizaci√≥n crear√° el producto en WooCommerce y guardar√° la relaci√≥n
                                </div>
                            </div>

                        </div>
                    </div>
                {% endif %}

                {# Debug Info (remove in production) #}

                <div class="card shadow mb-4">
                    <div class="card-body bg-light">
                        <h6>Debug Info:</h6>
                        <small>
                            <strong>FS Product:</strong><br>
                            ID: {{ fsc.model.idproducto ?? 'null' }}<br>
                            Referencia: {{ fsc.model.referencia ?? 'null' }}<br>
                            Descripci√≥n: {{ fsc.model.descripcion ?? 'null' }}<br>
                            Precio: {{ fsc.model.precio ?? 'null' }}<br>
                            Stock: {{ fsc.model.stockfis ?? 'null' }}<br>

                            <strong>WooCommerce Data:</strong><br>
                            WooCommerce ID: {{ fsc.model.woo_id ?? 'null' }}<br>
                            Status: {{ fsc.model.woo_status ?? 'null' }}<br>
                            Categories: {{ fsc.model.woo_categories ?? 'null' }}<br>
                            Last Update: {{ fsc.model.woo_last_update ?? 'null' }}<br>

                            <strong>System:</strong><br>
                            Current View: {{ currentView.getViewName() }}<br>
                            URL: {{ fsc.url() }}
                        </small>
                    </div>
                </div>


            </div>
        </div>
    </div>

    {# Create Category Modal #}
    <div id="createCategoryModal" class="modal">
        <div class="modal-content">
            <h4><i class="fas fa-plus-circle"></i> Crear Nueva Categor√≠a</h4>
            <div class="form-group">
                <label for="newCategoryName">Nombre de la Categor√≠a:</label>
                <input type="text" class="form-control" id="newCategoryName"
                       placeholder="Ingresa el nombre de la categor√≠a">
                <div class="field-help mt-2">La categor√≠a se crear√° como categor√≠a principal (sin padre)</div>
            </div>
            <div class="text-right mt-3">
                <button type="button" class="btn btn-secondary mr-2" onclick="hideCreateCategoryModal()">Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="createNewCategory()">
                    <i class="fas fa-plus"></i> Crear Categor√≠a
                </button>
            </div>
        </div>
    </div>

{% endblock %}